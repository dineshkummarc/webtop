(function(d,c,f){var b=(function(){var m=[],i=[],p=0,q=1,s=c.document,l="px",j=parseInt,k=Array.prototype.splice,h,u=[],r,A,n=function(z){z.preventDefault()};consts={HEADER_HEIGHT:25,TASK_BAR_HEIGHT:50,DEFAULT:1,MAXIMIZED:2,NEW_TASK:0,RIGHT_CLICK:1,TASK_MINIMIZED:3,TASK_MAXIMIZED:4,TASK_RESTORED:5};d(s).ready(function(){o()});function o(){d(s.body).bind("selectstart",n);h=new Raphael("canvas",0,0,d(c).width(),d(c).height());r=d("#canvas")}function v(C,z,B){x=C.pageX;y=C.pageY;A=new e(x,y,h,z,B);r.bind("mousemove",function(D,E){var D=E||D;x=D.pageX;y=D.pageY;if(A){A.updateEnd(x,y)}});r.mouseup(function(D){if(A){A.destroy();A=null}});return A}function t(z,H,D){if(z.length){var B=H.offset(),E=D.offset(),G=[B.left,B.top,E.left,E.top],F;for(var C=0;C<z.length;C++){F=z[C];if(F.i){F.s?z[C].l.updateStart(G[0]+10,G[1]+15):z[C].l.updateEnd(G[0]+10,G[1]+15)}else{F.s?z[C].l.updateStart(G[2]+15,G[3]+15):z[C].l.updateEnd(G[2]+15,G[3]+15)}}}}function w(D,C){var B=0,z=u.length;for(;B<z;B++){if(u[B][0]==D&&u[B][1]==C){return true}}return false}return{get:function(B){var z=m[B];return{close:function(){if(z){s.body.removeChild(z.node);delete m[B];p--}b.events.dispatch(b.c("NEW_TASK"))},maximize:function(){if(z.state!==b.c("MAXIMIZED")){var C=d(c).height()-b.c("TASK_BAR_HEIGHT")+l;d(z.node).css({width:"100%",height:C,left:"0px",top:"0px"});d("div.window-inner",z.node).css({height:C,width:"100%"});z.state=b.c("MAXIMIZED");z.node.style.zIndex=p++;d(z.node).draggable("option","disabled",true).resizable("option","disabled",true)}else{this.restore();d(z.node).draggable("option","disabled",false).resizable("option","disabled",false)}},minimize:function(){d(z.node).hide("fast");z.state*=-1},focus:function(){d(z.node).show("fast");z.node.style.zIndex=p++},restore:function(){this.focus();if(z.state===b.c("MAXIMIZED")){d(z.node).css({width:z.dim.w,height:z.dim.h+l,left:z.dim.x+l,top:z.dim.y+l});var C=d("div.window-inner",z.node),D=C.hasClass("full")?0:b.c("HEADER_HEIGHT");C.css({width:z.dim.w,height:z.dim.h-D+l});z.state=b.c("DEFAULT")}z.state=Math.abs(z.state)}}},run:function(B){var G=s.createElement("div"),z=d(G),P=APPLIST[B],H=m.length,J,K,Q=[];if(P.single){var O=this.api.findTask(B);if(O){this.get(O[0]).restore();return}}G.id="app"+H;z.addClass("window").css({width:P.width,height:P.height+l,zIndex:(P.alwaysOntop?1000:p++)}).html((P.route!==false?em({"class":"input"})+em({"class":"output"}):"")+div({"class":"window-header"},strong(P.title),span(a({"class":"min"},"[-]"),a({"class":"max"},"[_]"),a({"class":"close"},"[x]")))+div({"class":"window-inner loading"}));if(P.css){z.css(P.css)}m.push({id:B,node:G,dim:{w:P.width,h:P.height,x:10,y:10},state:b.c("DEFAULT")});var F=s.createElement("iframe"),N=d("div.window-inner",G);d(F).attr({frameBorder:"0",allowTransparency:"true",src:P.src}).hide();N.append(F).css("height",P.height-b.c("HEADER_HEIGHT")+l);if(P.header===false){d("div.window-header",G).addClass("hidden");N.addClass("full").css("height",P.height)}s.body.appendChild(G);var L=this.get(m.length-1);d("a.min",G).click(function(){L.minimize()});d("a.max",G).click(function(){L.maximize()});d("a.close",G).click(function(){L.close()});var C=F.contentWindow||F.contentDocument,M=d(F);C.Webtop=b;C.App=L;M.load(function(){N.removeClass("loading");M.show()});var E=function(R){M.hide();d(R).addClass("drag")},D=function(R){M.show();d(R).removeClass("drag")};d("div.window-header",G).bind("dragstart",n).bind("selectstart",n).bind("mousedown",function(){L.focus()}).dblclick(function(){L.maximize()});if(P.routes!==false){var I=d("em",G);J=d(I[0]);K=d(I[1]);I.bind("dragstart",n).bind("selectstart",n).mousedown(function(S){var R=d(this).hasClass("input");A=v(S,H,R);Q.push({l:A,i:R,s:true})}).mouseup(function(){r.unbind("mousemove");var R,S=true;if(A.getIndex()==H){S=false}if(d(this).hasClass("input")){if(w(A.getIndex(),H)||A.isInput()){S=false}R=[A.getIndex(),H]}else{if(w(H,A.getIndex())||!A.isInput()){S=false}R=[H,A.getIndex()]}if(S){u.push(R);Q.push({l:A,i:d(this).hasClass("input"),s:false});A.setRoute(R)}else{A.destroy()}A=null}).mousemove(function(R){r.trigger("mousemove",R)}).mouseover(function(R){if(A&&A.getIndex()!==H&&(d(this).hasClass("input")&&!(w(A.getIndex(),H)||A.isInput())||d(this).hasClass("output")&&!(w(H,A.getIndex())||!A.isInput()))){d(this).addClass("over")}}).mouseout(function(R){d(this).removeClass("over")})}if(P.draggable!==false){z.draggable({handle:"div.window-header",scroll:false,containment:"document",start:function(){E(this);r.hide()},stop:function(){r.show();D(this);var R=[j(d(this).css("left")),j(d(this).css("top")),d(this).width()];m[H].dim.x=R[0];m[H].dim.y=R[1];t(Q,J,K)}})}if(P.resizable!==false){z.resizable({containment:"document",autoHide:true,alsoResize:N,start:function(){E(this);r.hide();if(m[H].state===b.c("MAXIMIZED")){L.maximize()}},stop:function(){D(this);r.show();m[H].dim.w=d(this).css("width");m[H].dim.h=parseInt(d(this).css("height"),10);t(Q,J,K)}})}b.events.dispatch(b.c("NEW_TASK"))},api:{findTask:function(D){var C=[],B=0,z;for(z=m.length;B<z;B++){if(m[B]&&m[B].id===D){C.push(B)}}return C.length>0?C:false},getTasks:function(){return m},taskOptions:function(z){return APPLIST[z]}},events:{attach:function(B,C,z){if(i[C]===f){i[C]=[]}i[C].push({obj:B,handler:z})},dispatch:function(F,E){var D=i[F],B=0,z,C;if(D!==f){for(z=D.length;B<z;B++){C=D[B];C.handler.call(C.obj)}}}},c:function(z){return consts[z]},route:{destroy:function(D,C){console.log(D,C);var B=0,z=u.length;for(;B<z;B++){if(u[B][0]===D&&u[B][1]===C){u.splice(B,1);break}}}},routes:function(){return u},cm:function(G,B,D){var z=s.createDocumentFragment();if(!D){var D=s.createElement("ul");s.body.appendChild(D);d(D).addClass("ui-context-menu").hide();B.oncontextmenu=function(){return false};d(B).mousedown(function(I){if(I.which===3){I.preventDefault();d(D).show();return false}})}for(var F in G){var H=s.createElement("li");d(H).text(F).click(function(){d("ul:first",this).show("fast").mousedown(function(J){J.stopPropagation()});var I=this;d(this).parent().mousedown(function(){d("ul",I).hide("fast")});d(s).mousedown(function(){d("ul:first",I).hide("fast");d(I).parent().hide("fast")});return false}).mousedown(function(I){I.stopPropagation()});z.appendChild(H);var C=G[F];if(d.isFunction(C)){H.onclick=C}else{if(d.isPlainObject(C)){var E=s.createElement("ul");E.setAttribute("class","ui-menu-bar-root");H.appendChild(E);this.cm(C,B,E)}}}D.appendChild(z)}}})();function g(){return"#"+Math.round(16777215*Math.random()).toString(16)}function e(l,k,q,m,n){var h={x:l,y:k},j={x:l,y:k},r=function(){return"M"+h.x+" "+h.y+" L"+j.x+" "+j.y},p=function(){i.attr("path",r())},o,i=q.path(r());i.attr({stroke:g(),"stroke-width":2});i.dblclick(function(){this.remove();b.route.destroy(o[0],o[1])});return{updateStart:function(s,t){h.x=s;h.y=t;p();return this},updateEnd:function(s,t){j.x=s;j.y=t;p();return this},destroy:function(){i.remove()},getIndex:function(){return m},isInput:function(){return n},setRoute:function(s){o=s}}}c.Webtop=b})(jQuery,window);