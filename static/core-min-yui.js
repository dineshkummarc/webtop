(function(d,c,f){var b=(function(){var k=[],h=[],n=0,o=1,q=c.document,j="px",i=parseInt,g,r=[],p,t,m={HEADER_HEIGHT:25,TASK_BAR_HEIGHT:50,DEFAULT:1,MAXIMIZED:2,NEW_TASK:0,RIGHT_CLICK:1,TASK_MINIMIZED:3,TASK_MAXIMIZED:4,TASK_RESTORED:5};d(q).ready(function(){l()});function l(){d(q.body).bind("selectstart",function(u){u.preventDefault()});g=new Raphael("canvas",0,0,d(c).width(),d(c).height());p=d("#canvas")}function s(v,u){x=v.pageX;y=v.pageY;t=new e(x,y,x,y,g,u);p.bind("mousemove",function(w,z){var w=z||w;x=w.pageX;y=w.pageY;t.updateEnd(x,y)});p.mouseup(function(w){if(t){t.destroy()}});return t}return{get:function(v){var u=k[v];return{close:function(){if(u){q.body.removeChild(u.node);delete k[v];n--}b.events.dispatch(b.c("NEW_TASK"))},maximize:function(){if(u.state!==b.c("MAXIMIZED")){var w=d(c).height()-b.c("TASK_BAR_HEIGHT")+j;d(u.node).css({width:"100%",height:w,left:"0px",top:"0px"});d("div.window-inner",u.node).css({height:w,width:"100%"});u.state=b.c("MAXIMIZED");u.node.style.zIndex=n++;d(u.node).draggable("option","disabled",true).resizable("option","disabled",true)}else{this.restore();d(u.node).draggable("option","disabled",false).resizable("option","disabled",false)}},minimize:function(){d(u.node).hide("fast");u.state*=-1},focus:function(){d(u.node).show("fast");u.node.style.zIndex=n++},restore:function(){this.focus();if(u.state===b.c("MAXIMIZED")){d(u.node).css({width:u.dim.w,height:u.dim.h+j,left:u.dim.x+j,top:u.dim.y+j});var z=d("div.window-inner",u.node),A=z.hasClass("full")?0:b.c("HEADER_HEIGHT");z.css({width:u.dim.w,height:u.dim.h-A+j});u.state=b.c("DEFAULT")}u.state=Math.abs(u.state)}}},run:function(J){var F=q.createElement("div"),L=d(F),z=APPLIST[J],B=k.length,w,I,v=[];if(z.single){var E=this.api.findTask(J);if(E){this.get(E[0]).restore();return}}F.id="app"+B;L.addClass("window").css({width:z.width,height:z.height+j,zIndex:(z.alwaysOntop?1000:n++)}).html((z.route!==false?em({"class":"input"})+em({"class":"output"}):"")+div({"class":"window-header"},strong(z.title),span(a({"class":"min"},"[-]"),a({"class":"max"},"[_]"),a({"class":"close"},"[x]")))+div({"class":"window-inner loading"}));if(z.css){L.css(z.css)}k.push({id:J,node:F,dim:{w:z.width,h:z.height,x:10,y:10},state:b.c("DEFAULT")});var C=q.createElement("iframe"),N=d("div.window-inner",F);d(C).attr({frameBorder:"0",allowTransparency:"true",src:z.src}).hide();N.append(C).css("height",z.height-b.c("HEADER_HEIGHT")+j);if(z.header===false){d("div.window-header",F).addClass("hidden");N.addClass("full").css("height",z.height)}q.body.appendChild(F);var H=this.get(k.length-1);d("a.min",F).click(function(){H.minimize()});d("a.max",F).click(function(){H.maximize()});d("a.close",F).click(function(){H.close()});var K=C.contentWindow||C.contentDocument,G=d(C);K.Webtop=b;K.App=H;G.load(function(){N.removeClass("loading");G.show()});var D=function(O){O.preventDefault()},u=function(O){G.hide();d(O).addClass("drag")},A=function(O){G.show();d(O).removeClass("drag")};d("div.window-header",F).bind("dragstart",D).bind("selectstart",D).bind("mousedown",function(){H.focus()}).dblclick(function(){H.maximize()});if(z.routes!==false){var M=d("em",F);w=d(M[0]);I=d(M[1]);M.mousedown(function(O){t=s(O,B);v.push({l:t,i:d(this).hasClass("input"),s:true})}).mouseup(function(){p.unbind("mousemove");var O=(d(this).hasClass("input")?[t.getIndex(),B]:[B,t.getIndex()]);r.push(O);v.push({l:t,i:d(this).hasClass("input"),s:false});t=null}).mousemove(function(O){p.trigger("mousemove",O)})}if(z.draggable!==false){L.draggable({handle:"div.window-header",scroll:false,containment:"document",start:function(){u(this);p.hide()},stop:function(){p.show();A(this);var S=[i(d(this).css("left")),i(d(this).css("top")),d(this).width()];k[B].dim.x=S[0];k[B].dim.y=S[1];if(v.length){var O=w.offset(),Q=I.offset(),S=[O.left,O.top,Q.left,Q.top],R;for(var P=0;P<v.length;P++){R=v[P];if(R.i){R.s?v[P].l.updateStart(S[0]+10,S[1]+15):v[P].l.updateEnd(S[0]+10,S[1]+15)}else{R.s?v[P].l.updateStart(S[2]+15,S[3]+15):v[P].l.updateEnd(S[2]+15,S[3]+15)}}}}})}if(z.resizable!==false){L.resizable({containment:"document",autoHide:true,alsoResize:N,start:function(){u(this);if(k[B].state===b.c("MAXIMIZED")){H.maximize()}},stop:function(){A(this);k[B].dim.w=d(this).css("width");k[B].dim.h=parseInt(d(this).css("height"),10)}})}b.events.dispatch(b.c("NEW_TASK"))},api:{findTask:function(z){var w=[],v=0,u;for(u=k.length;v<u;v++){if(k[v]&&k[v].id===z){w.push(v)}}return w.length>0?w:false},getTasks:function(){return k},taskOptions:function(u){return APPLIST[u]}},events:{attach:function(v,w,u){if(h[w]===f){h[w]=[]}h[w].push({obj:v,handler:u})},dispatch:function(B,A){var z=h[B],v=0,u,w;if(z!==f){for(u=z.length;v<u;v++){w=z[v];w.handler.call(w.obj)}}}},c:function(u){return m[u]},routes:function(){return r},cm:function(C,v,z){var u=q.createDocumentFragment();if(!z){var z=q.createElement("ul");q.body.appendChild(z);d(z).addClass("ui-context-menu").hide();v.oncontextmenu=function(){return false};d(v).mousedown(function(E){if(E.which===3){E.preventDefault();d(z).show();return false}})}for(var B in C){var D=q.createElement("li");d(D).text(B).click(function(){d("ul:first",this).show("fast").mousedown(function(F){F.stopPropagation()});var E=this;d(this).parent().mousedown(function(){d("ul",E).hide("fast")});d(q).mousedown(function(){d("ul:first",E).hide("fast");d(E).parent().hide("fast")});return false}).mousedown(function(E){E.stopPropagation()});u.appendChild(D);var w=C[B];if(d.isFunction(w)){D.onclick=w}else{if(d.isPlainObject(w)){var A=q.createElement("ul");A.setAttribute("class","ui-menu-bar-root");D.appendChild(A);this.cm(w,v,A)}}}z.appendChild(u)}}})();function e(k,j,o,m,q,l){var g={x:k,y:j},i={x:o,y:m},p=function(){return"M"+g.x+" "+g.y+" L"+i.x+" "+i.y},n=function(){h.attr("path",p())},h=q.path(p());return{updateStart:function(r,s){g.x=r;g.y=s;n();return this},updateEnd:function(r,s){i.x=r;i.y=s;n();return this},destroy:function(){h.remove()},getIndex:function(){return l}}}c.Webtop=b})(jQuery,window);